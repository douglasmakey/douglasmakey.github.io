<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26 | KungFu Developer</title><meta name=keywords content="k8s,cel,admissioncontroller,validatingadmissionpolicy"><meta name=description content="The Kubernetes crew just dropped the latest version, k8s 1.26 a few days ago, and it&rsquo;s packed with some seriously cool new features. One that&rsquo;s catching my eye is CEL for admission control - it allows us to create a ValidatingAdmissionPolicy, taking our cluster security to the next level.
Validating admission policies offer a declarative, in-process alternative to validating admission webhooks.
Validating admission policies use the Common Expression Language (CEL) to declare the validation rules of a policy."><meta name=author content="Me"><link rel=canonical href=https://www.kungfudev.com/posts/cel-for-admission-controller/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.kungfudev.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.kungfudev.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.kungfudev.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.kungfudev.com/apple-touch-icon.png><link rel=mask-icon href=https://www.kungfudev.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.kungfudev.com/posts/cel-for-admission-controller/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26"><meta property="og:description" content="The Kubernetes crew just dropped the latest version, k8s 1.26 a few days ago, and it&rsquo;s packed with some seriously cool new features. One that&rsquo;s catching my eye is CEL for admission control - it allows us to create a ValidatingAdmissionPolicy, taking our cluster security to the next level.
Validating admission policies offer a declarative, in-process alternative to validating admission webhooks.
Validating admission policies use the Common Expression Language (CEL) to declare the validation rules of a policy."><meta property="og:type" content="article"><meta property="og:url" content="https://www.kungfudev.com/posts/cel-for-admission-controller/"><meta property="og:image" content="https://www.kungfudev.com/img/scenes-from-kubernetes-by-julia-evans.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-19T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-19T00:00:00+00:00"><meta property="og:site_name" content="I'm a Kung Fu Deveveloper"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.kungfudev.com/img/scenes-from-kubernetes-by-julia-evans.png"><meta name=twitter:title content="CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26"><meta name=twitter:description content="The Kubernetes crew just dropped the latest version, k8s 1.26 a few days ago, and it&rsquo;s packed with some seriously cool new features. One that&rsquo;s catching my eye is CEL for admission control - it allows us to create a ValidatingAdmissionPolicy, taking our cluster security to the next level.
Validating admission policies offer a declarative, in-process alternative to validating admission webhooks.
Validating admission policies use the Common Expression Language (CEL) to declare the validation rules of a policy."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.kungfudev.com/posts/"},{"@type":"ListItem","position":3,"name":"CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26","item":"https://www.kungfudev.com/posts/cel-for-admission-controller/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26","name":"CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26","description":"The Kubernetes crew just dropped the latest version, k8s 1.26 a few days ago, and it\u0026rsquo;s packed with some seriously cool new features. One that\u0026rsquo;s catching my eye is CEL for admission control - it allows us to create a ValidatingAdmissionPolicy, taking our cluster security to the next level.\nValidating admission policies offer a declarative, in-process alternative to validating admission webhooks.\nValidating admission policies use the Common Expression Language (CEL) to declare the validation rules of a policy.","keywords":["k8s","cel","admissioncontroller","validatingadmissionpolicy"],"articleBody":"The Kubernetes crew just dropped the latest version, k8s 1.26 a few days ago, and it’s packed with some seriously cool new features. One that’s catching my eye is CEL for admission control - it allows us to create a ValidatingAdmissionPolicy, taking our cluster security to the next level.\nValidating admission policies offer a declarative, in-process alternative to validating admission webhooks.\nValidating admission policies use the Common Expression Language (CEL) to declare the validation rules of a policy.\nWhat is CEL? The Common Expression Language (CEL) implements common semantics for expression evaluation, enabling different applications to more easily interoperate. https://github.com/google/cel-spec\nIt is a programming language used in Kubernetes to create custom admission control policies. It allows for creating complex, fine-grained policies to enforce security and compliance in a cluster.\nIn a previous article, we explored how Kubernetes admission controllers can be used to enforce validations, such as preventing the use of the latest tag for container images. In this post, we’ll delve into the new ValidatingAdmissionPolicy feature, which allows us to take our validation capabilities even further in a much simple way without dealing with webhooks!\nTesting K8s 1.26 locally For local testing, you can use tools like kind or microk8s.\nBefore using either kind or microk8s, make sure to enable the ValidatingAdmissionPolicy feature gate and the admissionregistration.k8s.io/v1alpha1 API.\nmicrok8s - https://microk8s.io microk8s install --channel 1.26 You’ll need to edit the kube-apiserver file located at the address specified in the snippet below to activate the necessary features.\n$ vim /var/snap/microk8s/current/args/kube-apiserver ... --feature-gates=ValidatingAdmissionPolicy=true --runtime-config=admissionregistration.k8s.io/v1alpha1=true ... If you’re using a Mac and have microk8s installed, it uses multipass as VM. To access the VM, run the following command:\n$ multipass list Name State IPv4 Image microk8s-vm Running 192.168.64.5 Ubuntu 18.04 LTS $ multipass shell microk8s-vm kind - https://kind.sigs.k8s.io With kind, you can create a cluster using a configuration file written in YAML that contains all the necessary settings.\nkind: Cluster name: demo-cel apiVersion: kind.x-k8s.io/v1alpha4 featureGates: \"ValidatingAdmissionPolicy\": true runtimeConfig: \"admissionregistration.k8s.io/v1alpha1\": true nodes: - role: control-plane image: kindest/node:v1.26.0 Run\n$ kind create cluster --config=cluster.yaml For both kind and microk8s, you can use kubectl to check if all required features are enabled.\n$ kubectl api-versions | grep admissionregistration admissionregistration.k8s.io/v1alpha1 $ kubectl api-resources | grep ValidatingAdmissionPolicy validatingadmissionpolicies admissionregistration.k8s.io/v1alpha1 false ValidatingAdmissionPolicy validatingadmissionpolicybindings admissionregistration.k8s.io/v1alpha1 false ValidatingAdmissionPolicyBinding Now that you have your cluster set up, you are ready to start experimenting with ValidatingAdmissionPolicy.\nPlaying To create a policy, you need to create the following:\nA ValidatingAdmissionPolicy that outlines the abstract logic of the policy (e.g. “this policy ensures that a specific label is set to a specific value”). And a ValidatingAdmissionPolicyBinding that connects the ValidatingAdmissionPolicy to a specific scope or context.\" Let’s say you want to create a policy that ensures high availability in production deployments by requiring a minimum of 3 replicas. This policy could be implemented using the following ValidatingAdmissionPolicy and ValidatingAdmissionPolicyBinding resources:\napiVersion: admissionregistration.k8s.io/v1alpha1 kind: ValidatingAdmissionPolicy metadata: name: \"force-ha-in-prod\" spec: failurePolicy: Fail matchConstraints: resourceRules: - apiGroups: [\"apps\"] apiVersions: [\"v1\"] operations: [\"CREATE\", \"UPDATE\"] resources: [\"deployments\"] validations: - expression: \"object.spec.replicas \u003e= 3\" message: \"All production deployments should be HA with at least three replicas\" The YAML above shows how you can specify which resources and operations will be affected by the policy. Within the spect.validations section, you can use CEL to define the expressions that the resource must satisfy to be accepted by the policy. If an expression evaluates to false, the validation check is enforced according to the spec.failurePolicy field.\nAccording to the official Kubernetes documentation, CEL expressions can access the contents of Admission requests and responses through a number of variables:\nobject: The object from the incoming request (null for DELETE requests). oldObject: The existing object (null for CREATE requests). request: Attributes of the admission request. params: The parameter resource referred to by the policy binding being evaluated (null if ParamKind is unset). Now that you have your first policy, you need to bind it using a ValidatingAdmissionPolicyBinding:\napiVersion: admissionregistration.k8s.io/v1alpha1 kind: ValidatingAdmissionPolicyBinding metadata: name: \"force-ha-in-prod-binding\" spec: policyName: \"force-ha-in-prod\" matchResources: namespaceSelector: matchLabels: env: production The MatchResources decides whether to run the admission control policy on an object based on whether it meets the match criteria. In this case, you’re using namespaceSelector to apply the policy to all namespaces labeled with env: production.\nMaybe you want to use objectSelector, which decides whether to run the validation based on if the object has matching labels. It is evaluated against both the old and new versions of an object, allowing you to set up validations that ensure that resources are not changed in certain ways.\napiVersion: admissionregistration.k8s.io/v1alpha1 kind: ValidatingAdmissionPolicyBinding metadata: name: \"force-ha-in-prod-object-binding\" spec: policyName: \"force-ha-in-prod\" matchResources: objectSelector: matchLabels: from: kungfudev Of course, you can also use an empty LabelSelector, which will match all objects. This can be useful if you want your policy to run on all resources, regardless of their labels.\napiVersion: admissionregistration.k8s.io/v1alpha1 kind: ValidatingAdmissionPolicyBinding metadata: name: \"force-ha-in-prod-for-all-binding\" spec: policyName: \"force-ha-in-prod\" matchResources: To test the policy you can try to apply the following YAML, which includes a namespace and a deployment with only two replicas.\napiVersion: v1 kind: Namespace metadata: name: payments-system labels: env: production --- apiVersion: apps/v1 kind: Deployment metadata: namespace: payments-system name: payment-gateway labels: app: nginx from: kungfudev spec: replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.23.3 ports: - containerPort: 80 Testing it:\n$ kubectl apply -f force-ha-in-prod.yaml validatingadmissionpolicy.admissionregistration.k8s.io/force-ha-in-prod created $ kubectl apply -f force-ha-in-prod-binding.yaml validatingadmissionpolicybinding.admissionregistration.k8s.io/force-ha-in-prod-binding created $ kubectl apply -f payment-deployment.yaml The deployments \"payment-gateway\" is invalid: : ValidatingAdmissionPolicy 'force-ha-in-prod' with binding 'force-ha-in-prod-binding' denied request: All production deployments should be HA with at least three replicas The policy rejects the deployment because it does not meet the requirements defined in the policy’s validation. However, if you modify the deployment to use 4 replicas instead of 2, the policy should allow it.\n... spec: replicas: 4 selector: matchLabels: ... $ kubectl apply -f payment-deployment.yaml deployment.apps/payment-gateway created Wow, we just made sure all our production deployments are highly available with a few simple moves! Our policy is pretty basic for now, but there’s no stopping us from creating more complex validations. Imagine not allowing the “latest” tag, only allowing images from our own registry, or making sure all containers have CPU limits set. The possibilities are endless with the power of ValidatingAdmissionPolicy at our fingertips!\nBy harnessing the full capabilities of CEL, we can chain multiple expressions to create more intricate validations.\nTo learn about additional features and capabilities offered by CEL, please visit this link.\napiVersion: admissionregistration.k8s.io/v1alpha1 kind: ValidatingAdmissionPolicy metadata: name: \"prod-ready-policy\" spec: failurePolicy: Fail matchConstraints: resourceRules: - apiGroups: [\"apps\"] apiVersions: [\"v1\"] operations: [\"CREATE\", \"UPDATE\"] resources: [\"deployments\"] validations: - expression: \"object.spec.template.spec.containers.all(c, !c.image.endsWith(':latest'))\" message: \"cannot use the latest tag\" - expression: \"object.spec.template.spec.containers.all(c, c.image.startsWith('myregistry.com/'))\" message: \"image from an untrusted registry\" - expression: \"has(object.metadata.labels.env) \u0026\u0026 object.metadata.labels.env in ['prod', 'production']\" message: \"deployment should have an env and have to be prod or production\" - expression: | object.spec.template.spec.containers.all( c, has(c.resources) \u0026\u0026 has(c.resources.limits) \u0026\u0026 has(c.resources.limits.cpu) ) message: \"container does not have a cpu limit set\" --- apiVersion: admissionregistration.k8s.io/v1alpha1 kind: ValidatingAdmissionPolicyBinding metadata: name: \"prod-reay-policy-binding\" spec: policyName: \"prod-reay-policy\" matchResources: namespaceSelector: matchExpressions: - key: \"env\" operator: \"In\" values: [prod, production,] In the YAML above, you’ll notice that we can use matchExpressions during binding to give our policy a more dynamic scope.\nThe ValidatingAdmissionPolicy feature also includes Parameter resources, which allow you to separate the policy configuration from its definition. This means that, for example, instead of hardcoding the minimum number of replicas for all namespaces in the HA Policy, you can use a parameter and configure different values for different environments. Check out the official documentation for more information on how to use this feature.\nIn Conclusion With CEL and the new ValidatingAdmissionPolicy feature in k8s 1.26, we now have the power to create custom, complex policies to enforce security and compliance in our clusters.\nWe know that Open Policy Agent (OPA) is widely used, but ValidatingAdmissionPolicy + CEL is designed to be more lightweight and easier to use than OPA. ValidatingAdmissionPolicy is natively integrated with Kubernetes, which means that it can be used directly within the Kubernetes API server without requiring a separate policy engine.\nThere are pros and cons to using either OPA or ValidatingAdmissionPolicy + CEL for policy enforcement in Kubernetes. OPA could be a more feature-rich and powerful policy engine, but it may require more setup and maintenance. ValidatingAdmissionPolicy + CEL is easier to use and integrates more seamlessly with Kubernetes, but it may not have all the advanced features of OPA. Ultimately, the choice of which policy engine to use will depend on the specific requirements and preferences of the user.\nFind all the YAML files and even more examples in this repository.\nThanks for following along, and I hope you found this article helpful and easy to understand. Happy cluster building!\n","wordCount":"1460","inLanguage":"en","image":"https://www.kungfudev.com/img/scenes-from-kubernetes-by-julia-evans.png","datePublished":"2022-12-19T00:00:00Z","dateModified":"2022-12-19T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.kungfudev.com/posts/cel-for-admission-controller/"},"publisher":{"@type":"Organization","name":"KungFu Developer","logo":{"@type":"ImageObject","url":"https://www.kungfudev.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.kungfudev.com accesskey=h title="KungFu Developer (Alt + H)">KungFu Developer</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://www.kungfudev.com/es/ title=Español aria-label=Español>Es</a></li></ul></div></div><ul id=menu><li><a href=https://www.kungfudev.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://www.kungfudev.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.kungfudev.com/archives/ title=Archives><span>Archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.kungfudev.com>Home</a>&nbsp;»&nbsp;<a href=https://www.kungfudev.com/posts/>Posts</a></div><h1 class=post-title>CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26</h1><div class=post-meta><span title='2022-12-19 00:00:00 +0000 UTC'>December 19, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Me</div></header><figure class=entry-cover><img loading=lazy src=https://www.kungfudev.com/img/scenes-from-kubernetes-by-julia-evans.png alt></figure><div class=post-content><p>The Kubernetes crew just dropped the latest version, k8s 1.26 a few days ago, and it&rsquo;s packed with some seriously cool new features. One that&rsquo;s catching my eye is CEL for admission control - it allows us to create a ValidatingAdmissionPolicy, taking our cluster security to the next level.</p><blockquote><p>Validating admission policies offer a declarative, in-process alternative to validating admission webhooks.</p><p>Validating admission policies use the Common Expression Language (CEL) to declare the validation rules of a policy.</p></blockquote><h3 id=what-is-cel>What is CEL?<a hidden class=anchor aria-hidden=true href=#what-is-cel>#</a></h3><blockquote><p>The Common Expression Language (CEL) implements common semantics for expression evaluation, enabling different applications to more easily interoperate.
<a href=https://github.com/google/cel-spec>https://github.com/google/cel-spec</a></p></blockquote><p>It is a programming language used in Kubernetes to create custom admission control policies. It allows for creating complex, fine-grained policies to enforce security and compliance in a cluster.</p><p>In a previous <a href=https://www.kungfudev.com/posts/implementing-k8s-admission-controller/>article</a>, we explored how Kubernetes admission controllers can be used to enforce validations, such as preventing the use of the latest tag for container images. In this post, we&rsquo;ll delve into the new ValidatingAdmissionPolicy feature, which allows us to take our validation capabilities even further in a much simple way without dealing with webhooks!</p><h2 id=testing-k8s-126-locally>Testing K8s 1.26 locally<a hidden class=anchor aria-hidden=true href=#testing-k8s-126-locally>#</a></h2><p>For local testing, you can use tools like <code>kind</code> or <code>microk8s</code>.</p><p>Before using either <code>kind</code> or <code>microk8s</code>, make sure to enable the <code>ValidatingAdmissionPolicy</code> feature gate and the <code>admissionregistration.k8s.io/v1alpha1</code> API.</p><h3 id=microk8s---httpsmicrok8sio>microk8s - <a href=https://microk8s.io>https://microk8s.io</a><a hidden class=anchor aria-hidden=true href=#microk8s---httpsmicrok8sio>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>microk8s install --channel 1.26
</span></span></code></pre></div><p>You&rsquo;ll need to edit the kube-apiserver file located at the address specified in the snippet below to activate the necessary features.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ vim /var/snap/microk8s/current/args/kube-apiserver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>--feature-gates=ValidatingAdmissionPolicy=true
</span></span><span class=line><span class=cl>--runtime-config=admissionregistration.k8s.io/v1alpha1=true
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>If you&rsquo;re using a Mac and have microk8s installed, it uses multipass as VM. To access the VM, run the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ multipass list
</span></span><span class=line><span class=cl>Name                    State             IPv4             Image
</span></span><span class=line><span class=cl>microk8s-vm             Running           192.168.64.5     Ubuntu 18.04 LTS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ multipass shell microk8s-vm
</span></span></code></pre></div><h3 id=kind---httpskindsigsk8sio>kind - <a href=https://kind.sigs.k8s.io>https://kind.sigs.k8s.io</a><a hidden class=anchor aria-hidden=true href=#kind---httpskindsigsk8sio>#</a></h3><p>With kind, you can create a cluster using a configuration file written in YAML that contains all the necessary settings.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-cel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kind.x-k8s.io/v1alpha4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>featureGates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>&#34;ValidatingAdmissionPolicy&#34;: </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>runtimeConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>&#34;admissionregistration.k8s.io/v1alpha1&#34;: </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>kindest/node:v1.26.0</span><span class=w>
</span></span></span></code></pre></div><p>Run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kind create cluster --config<span class=o>=</span>cluster.yaml
</span></span></code></pre></div><p>For both <code>kind</code> and <code>microk8s</code>, you can use kubectl to check if all required features are enabled.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl api-versions <span class=p>|</span> grep admissionregistration
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>admissionregistration.k8s.io/v1alpha1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl api-resources <span class=p>|</span> grep ValidatingAdmissionPolicy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>validatingadmissionpolicies                      admissionregistration.k8s.io/v1alpha1   <span class=nb>false</span>        ValidatingAdmissionPolicy
</span></span><span class=line><span class=cl>validatingadmissionpolicybindings                admissionregistration.k8s.io/v1alpha1   <span class=nb>false</span>        ValidatingAdmissionPolicyBinding
</span></span></code></pre></div><p>Now that you have your cluster set up, you are ready to start experimenting with <code>ValidatingAdmissionPolicy</code>.</p><h2 id=playing>Playing<a hidden class=anchor aria-hidden=true href=#playing>#</a></h2><p>To create a policy, you need to create the following:</p><ol><li>A ValidatingAdmissionPolicy that outlines the abstract logic of the policy (e.g. &ldquo;this policy ensures that a specific label is set to a specific value&rdquo;).</li><li>And a ValidatingAdmissionPolicyBinding that connects the ValidatingAdmissionPolicy to a specific scope or context."</li></ol><p>Let&rsquo;s say you want to create a policy that ensures high availability in production deployments by requiring a minimum of 3 replicas. This policy could be implemented using the following <code>ValidatingAdmissionPolicy</code> and <code>ValidatingAdmissionPolicyBinding</code> resources:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingAdmissionPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;force-ha-in-prod&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failurePolicy</span><span class=p>:</span><span class=w> </span><span class=l>Fail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resourceRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apiVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operations</span><span class=p>:</span><span class=w>  </span><span class=p>[</span><span class=s2>&#34;CREATE&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;UPDATE&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;deployments&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>validations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;object.spec.replicas &gt;= 3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;All production deployments should be HA with at least three replicas&#34;</span><span class=w>
</span></span></span></code></pre></div><p>The YAML above shows how you can specify which resources and operations will be affected by the policy. Within the <code>spect.validations</code> section, you can use CEL to define the expressions that the resource must satisfy to be accepted by the policy. If an expression evaluates to false, the validation check is enforced according to the <code>spec.failurePolicy</code> field.</p><p>According to the official Kubernetes <a href=https://kubernetes.io/docs/reference/access-authn-authz/validating-admission-policy/#validation-expression>documentation</a>, CEL expressions can access the contents of Admission requests and responses through a number of variables:</p><ul><li><strong>object</strong>: The object from the incoming request (null for DELETE requests).</li><li><strong>oldObject</strong>: The existing object (null for CREATE requests).</li><li><strong>request</strong>: Attributes of the admission request.</li><li><strong>params</strong>: The parameter resource referred to by the policy binding being evaluated (null if ParamKind is unset).</li></ul><p>Now that you have your first policy, you need to bind it using a <code>ValidatingAdmissionPolicyBinding</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingAdmissionPolicyBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;force-ha-in-prod-binding&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;force-ha-in-prod&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchResources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span></span></span></code></pre></div><p>The <code>MatchResources</code> decides whether to run the admission control policy on an object based on whether it meets the match criteria. In this case, you&rsquo;re using <code>namespaceSelector</code> to apply the policy to all namespaces labeled with <code>env: production</code>.</p><p>Maybe you want to use <code>objectSelector</code>, which decides whether to run the validation based on if the object has matching labels. It is evaluated against both the old and new versions of an object, allowing you to set up validations that ensure that resources are not changed in certain ways.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingAdmissionPolicyBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;force-ha-in-prod-object-binding&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;force-ha-in-prod&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchResources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>objectSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=l>kungfudev</span><span class=w>
</span></span></span></code></pre></div><p>Of course, you can also use an empty <code>LabelSelector</code>, which will match all objects. This can be useful if you want your policy to run on all resources, regardless of their labels.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingAdmissionPolicyBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;force-ha-in-prod-for-all-binding&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;force-ha-in-prod&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchResources</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>To test the policy you can try to apply the following YAML, which includes a namespace and a deployment with only two replicas.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>payments-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>payments-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>payment-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=l>kungfudev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.23.3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>Testing it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f force-ha-in-prod.yaml
</span></span><span class=line><span class=cl>validatingadmissionpolicy.admissionregistration.k8s.io/force-ha-in-prod created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl apply -f force-ha-in-prod-binding.yaml
</span></span><span class=line><span class=cl>validatingadmissionpolicybinding.admissionregistration.k8s.io/force-ha-in-prod-binding created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl apply -f payment-deployment.yaml
</span></span><span class=line><span class=cl>The deployments <span class=s2>&#34;payment-gateway&#34;</span> is invalid: : ValidatingAdmissionPolicy <span class=s1>&#39;force-ha-in-prod&#39;</span> with binding <span class=s1>&#39;force-ha-in-prod-binding&#39;</span> denied request: All production deployments should be HA with at least three replicas
</span></span></code></pre></div><p>The policy rejects the deployment because it does not meet the requirements defined in the policy&rsquo;s validation. However, if you modify the deployment to use 4 replicas instead of 2, the policy should allow it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f payment-deployment.yaml
</span></span><span class=line><span class=cl>deployment.apps/payment-gateway created
</span></span></code></pre></div><p>Wow, we just made sure all our production deployments are highly available with a few simple moves! Our policy is pretty basic for now, but there&rsquo;s no stopping us from creating more complex validations. Imagine not allowing the &ldquo;latest&rdquo; tag, only allowing images from our own registry, or making sure all containers have CPU limits set. The possibilities are endless with the power of <code>ValidatingAdmissionPolicy</code> at our fingertips!</p><p>By harnessing the full capabilities of CEL, we can chain multiple expressions to create more intricate validations.</p><p>To learn about additional features and capabilities offered by CEL, please visit this <a href=https://github.com/google/cel-spec/blob/master/doc/langdef.md>link</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingAdmissionPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;prod-ready-policy&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failurePolicy</span><span class=p>:</span><span class=w> </span><span class=l>Fail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resourceRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apiVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operations</span><span class=p>:</span><span class=w>  </span><span class=p>[</span><span class=s2>&#34;CREATE&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;UPDATE&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;deployments&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>validations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;object.spec.template.spec.containers.all(c, !c.image.endsWith(&#39;:latest&#39;))&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cannot use the latest tag&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;object.spec.template.spec.containers.all(c, c.image.startsWith(&#39;myregistry.com/&#39;))&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;image from an untrusted registry&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;has(object.metadata.labels.env) &amp;&amp; object.metadata.labels.env in [&#39;prod&#39;, &#39;production&#39;]&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment should have an env and have to be prod or production&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        object.spec.template.spec.containers.all(
</span></span></span><span class=line><span class=cl><span class=sd>          c, has(c.resources) &amp;&amp; has(c.resources.limits) &amp;&amp; has(c.resources.limits.cpu)
</span></span></span><span class=line><span class=cl><span class=sd>        )</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;container does not have a cpu limit set&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingAdmissionPolicyBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;prod-reay-policy-binding&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;prod-reay-policy&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchResources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;In&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>prod, production,]</span><span class=w>
</span></span></span></code></pre></div><p>In the YAML above, you&rsquo;ll notice that we can use <code>matchExpressions</code> during binding to give our policy a more dynamic scope.</p><p>The ValidatingAdmissionPolicy feature also includes Parameter resources, which allow you to separate the policy configuration from its definition. This means that, for example, instead of hardcoding the minimum number of replicas for all namespaces in the HA Policy, you can use a parameter and configure different values for different environments. Check out the official <a href=https://kubernetes.io/docs/reference/access-authn-authz/validating-admission-policy/#parameter-resources>documentation</a> for more information on how to use this feature.</p><h2 id=in-conclusion>In Conclusion<a hidden class=anchor aria-hidden=true href=#in-conclusion>#</a></h2><p>With CEL and the new ValidatingAdmissionPolicy feature in k8s 1.26, we now have the power to create custom, complex policies to enforce security and compliance in our clusters.</p><p>We know that Open Policy Agent (OPA) is widely used, but ValidatingAdmissionPolicy + CEL is designed to be more lightweight and easier to use than OPA. ValidatingAdmissionPolicy is natively integrated with Kubernetes, which means that it can be used directly within the Kubernetes API server without requiring a separate policy engine.</p><p>There are pros and cons to using either OPA or ValidatingAdmissionPolicy + CEL for policy enforcement in Kubernetes. OPA could be a more feature-rich and powerful policy engine, but it may require more setup and maintenance. ValidatingAdmissionPolicy + CEL is easier to use and integrates more seamlessly with Kubernetes, but it may not have all the advanced features of OPA. Ultimately, the choice of which policy engine to use will depend on the specific requirements and preferences of the user.</p><p>Find all the YAML files and even more examples in this <a href=https://github.com/douglasmakey/k8s-validating-admission-policy>repository</a>.</p><p>Thanks for following along, and I hope you found this article helpful and easy to understand. Happy cluster building!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.kungfudev.com/tags/k8s/>k8s</a></li><li><a href=https://www.kungfudev.com/tags/cel/>cel</a></li><li><a href=https://www.kungfudev.com/tags/admissioncontroller/>admissioncontroller</a></li><li><a href=https://www.kungfudev.com/tags/validatingadmissionpolicy/>validatingadmissionpolicy</a></li></ul><nav class=paginav><a class=next href=https://www.kungfudev.com/posts/simple-example-of-using-unix-domain-socket-in-kubernetes/><span class=title>Next »</span><br><span>A simple example of using unix domain socket in Kubernetes</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26 on twitter" href="https://twitter.com/intent/tweet/?text=CEL%20for%20admission%20controller%20with%20ValidatingAdmissionPolicy%20in%20K8s%201.26&url=https%3a%2f%2fwww.kungfudev.com%2fposts%2fcel-for-admission-controller%2f&hashtags=k8s%2ccel%2cadmissioncontroller%2cvalidatingadmissionpolicy"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.kungfudev.com%2fposts%2fcel-for-admission-controller%2f&title=CEL%20for%20admission%20controller%20with%20ValidatingAdmissionPolicy%20in%20K8s%201.26&summary=CEL%20for%20admission%20controller%20with%20ValidatingAdmissionPolicy%20in%20K8s%201.26&source=https%3a%2f%2fwww.kungfudev.com%2fposts%2fcel-for-admission-controller%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.kungfudev.com%2fposts%2fcel-for-admission-controller%2f&title=CEL%20for%20admission%20controller%20with%20ValidatingAdmissionPolicy%20in%20K8s%201.26"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.kungfudev.com%2fposts%2fcel-for-admission-controller%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26 on whatsapp" href="https://api.whatsapp.com/send?text=CEL%20for%20admission%20controller%20with%20ValidatingAdmissionPolicy%20in%20K8s%201.26%20-%20https%3a%2f%2fwww.kungfudev.com%2fposts%2fcel-for-admission-controller%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share CEL for admission controller with ValidatingAdmissionPolicy in K8s 1.26 on telegram" href="https://telegram.me/share/url?text=CEL%20for%20admission%20controller%20with%20ValidatingAdmissionPolicy%20in%20K8s%201.26&url=https%3a%2f%2fwww.kungfudev.com%2fposts%2fcel-for-admission-controller%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.kungfudev.com>KungFu Developer</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>